<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تطبيق خدمات السوريين</title>
<style>
body { font-family: Arial, sans-serif; background-color: #f0f4f8; color: #333; margin: 0; }
header { background-color: #4a90e2; color: white; padding: 15px; text-align: center; font-size: 24px; }
nav { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 20px 0; }
button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background-color: #ff8c42; color: white; transition: 0.3s; }
button:hover { background-color: #e67300; }
section { display: none; padding: 20px; text-align: center; }
.active { display: block; }
#login { text-align: center; margin-top: 50px; }
input, textarea, select { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
#services-list button { margin: 5px; }
</style>
</head>
<body>

<header>تطبيق خدمات السوريين</header>

<div id="login">
  <h2>تسجيل الدخول</h2>
  <input type="text" id="username" placeholder="اسم المستخدم"><br>
  <input type="password" id="password" placeholder="كلمة المرور"><br>
  <button onclick="login()">تسجيل الدخول</button>
</div>

<nav id="menu" style="display:none;">
  <button onclick="showSection('services')">الخدمات</button>
  <button onclick="showSection('reports')">البلاغات</button>
  <button onclick="showSection('transactions')">الحوالات المالية</button>
  <button id="admin-panel-btn" onclick="showSection('admin')" style="display:none;">لوحة المالك</button>
</nav>

<section id="services">
  <h3>الخدمات المتاحة</h3>
  <div id="services-list"></div>
</section>

<section id="reports">
  <h3>تقديم بلاغ</h3>
  <select id="report-service"></select><br><br>
  <textarea id="report-desc" placeholder="وصف البلاغ" rows="4" cols="50"></textarea><br><br>
  <button onclick="submitReport()">إرسال البلاغ</button>
</section>

<section id="transactions">
  <h3>إرسال حوالة مالية</h3>
  <input type="number" id="receiver-id" placeholder="رقم حساب المستلم"><br><br>
  <input type="number" id="amount" placeholder="المبلغ"><br><br>
  <button onclick="sendTransaction()">إرسال الحوالة</button>
</section>

<section id="admin">
  <h3>لوحة المالك - إدارة المشرفين</h3>

  <h4>إضافة مشرف جديد</h4>
  <input type="text" id="mod-username" placeholder="اسم المشرف"><br>
  <input type="password" id="mod-password" placeholder="كلمة المرور"><br>
  <select id="mod-role">
    <option value="moderator">مشرف عادي</option>
    <option value="admin">مالك فرعي</option>
  </select><br><br>
  <button onclick="addModerator()">إضافة المشرف</button>

  <h4>المشرفون الحاليون</h4>
  <div id="moderators-list"></div>
</section>

<script>
let token = '';
let userId = '';
let role = '';

async function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  // تحقق من رمز المالك
  if(password === '09962') {
    role = 'admin';
    userId = 'admin';
    alert('مرحبا مالك التطبيق!');
  } else {
    // تسجيل دخول للمستخدم العادي عبر API
    const res = await fetch('http://localhost:3000/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if(!res.ok){ alert(data.message); return; }
    token = data.token;
    role = data.role;
    userId = data.user_id;
    alert('مرحبا المستخدم!');
  }

  document.getElementById('login').style.display = 'none';
  document.getElementById('menu').style.display = 'flex';
  if(role === 'admin') document.getElementById('admin-panel-btn').style.display = 'inline-block';
  loadServices();
  if(role === 'admin') loadModerators();
}

async function loadServices() {
  const res = await fetch('http://localhost:3000/api/services');
  const services = await res.json();
  const list = document.getElementById('services-list');
  const select = document.getElementById('report-service');
  list.innerHTML = '';
  select.innerHTML = '';
  services.forEach(s => {
    list.innerHTML += `<button>${s.name}</button>`;
    select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
  });
}

function showSection(id){
  document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

async function submitReport() {
  const service_id = document.getElementById('report-service').value;
  const description = document.getElementById('report-desc').value;
  const res = await fetch('http://localhost:3000/api/reports', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ user_id: userId, service_id, description })
  });
  const data = await res.json();
  alert(data.message);
}

async function sendTransaction() {
  const receiver_id = document.getElementById('receiver-id').value;
  const amount = document.getElementById('amount').value;
  const res = await fetch('http://localhost:3000/api/transactions', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ sender_id: userId, receiver_id, amount })
  });
  const data = await res.json();
  alert(data.message);
}

async function addModerator() {
  const username = document.getElementById('mod-username').value;
  const password = document.getElementById('mod-password').value;
  const role = document.getElementById('mod-role').value;

  const res = await fetch('http://localhost:3000/api/users', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ username, password, role })
  });
  const data = await res.json();
  alert(data.message);
  loadModerators();
}

async function loadModerators() {
  const res = await fetch('http://localhost:3000/api/users', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const mods = await res.json();
  const list = document.getElementById('moderators-list');
  list.innerHTML = '';
  mods.forEach(m => {
    list.innerHTML += `<div>${m.username} - ${m.role} 
      <button onclick="deleteModerator(${m.id})">حذف</button>
      </div>`;
  });
}

async function deleteModerator(id) {
  const res = await fetch(`http://localhost:3000/api/users/${id}`, {
    method: 'DELETE',
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await res.json();
  alert(data.message);
  loadModerators();
}
</script>

</body>
</html>
